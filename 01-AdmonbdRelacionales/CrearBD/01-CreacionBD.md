### Universidad Tecnol칩gica de Tula-Tepeji.

#### Carrera: Ingenier칤a en Desarrollo y Gesti칩n de Software.

#### Unidad de Aprendizaje: 1

#### Evaluaci칩n: 3

#### Alumno: Vania Donaji Velazquez Torres.

#### Matricula: 22300049

#### Grupo: 8 IDGS-G1

#### Periodo: Enero-Abril 2025.

#### Docente: Ing. Jose Luis Herrera Gallardo
---

# CREAR BASE DE DATOS DIN츼MICAMENTE

## Procedimiento Almacenado
#### **Crear Store Procedure**
* Crear o alterar el Procedimiento Almacenado, le damos un nombre y declaramos las variables que se ocupar치n para la creaci칩n de la base de datos y lo que implica. Despu칠s lo que se tiene que hacer es declarar otra variable @sql, esta variable almacena la consulta SQL din치mica que se va construyendo mediante concatenaci칩n de cadenas. 

```sql
CREATE OR ALTER PROCEDURE SP_CreateDatabase
    @DatabaseName NVARCHAR(128),
    @DataFilePath NVARCHAR(256),
    @LogFilePath NVARCHAR(256),
    @DataSize INT,
    @LogSize INT,
    @FileGrowthData INT,
    @FileGrowthLog INT,
    @FileGroupAdicional NVARCHAR(128) = NULL
AS
BEGIN
    DECLARE @SQL NVARCHAR(MAX)
```
#### **Validaciones en SQL***
* Posteriormente, esta consulta se ejecuta con sp_executesql.
Hacemos las validaciones para que los campos que son obligatorios no vengan nulos o vac칤os.

```sql
-- VALIDACIONES
    IF @DatabaseName IS NULL OR @DatabaseName = ''
    BEGIN
        RAISERROR('El nombre de la base de datos no puede ser nulo o vac칤o', 16, 1)
        RETURN
    END

    IF @DataFilePath IS NULL OR @DataFilePath = '' OR @LogFilePath IS NULL OR @LogFilePath = ''
    BEGIN
        RAISERROR('Las ubicaciones de los archivos no pueden ser nulas o vac칤as', 16, 1)
        RETURN
    END

    IF @DataSize <= 0 OR @LogSize <= 0
    BEGIN
        RAISERROR('El tama침o de los archivos debe ser mayor que 0', 16, 1)
        RETURN
    END
```
#### **Crear los archivos de Data y Log**
* El siguiente paso es crear los archivos de Data y Log de nuestra base de datos, indicar el crecimiento de los archivos, donde se guardar치n, el nombre y su crecimiento al alcanzar su tama침o m치ximo. 
Y ejecutamos la variable din치mica.

```sql
    -- CREAR BD DATA
    SET @SQL = 'CREATE DATABASE [' + @DatabaseName + '] 
                ON ( NAME = N''' + @DatabaseName + '_Data'', 
                     FILENAME = N''' + @DataFilePath + '\' + @DatabaseName + '.mdf'', 
                     SIZE = ' + CAST(@DataSize AS NVARCHAR) + 'MB, 
                     FILEGROWTH = ' + CAST(@FileGrowthData AS NVARCHAR) + 'MB ) '

    -- LOG
    SET @SQL = @SQL + ' LOG ON 
                    ( NAME = N''' + @DatabaseName + '_Log'', 
                        FILENAME = N''' + @LogFilePath + '\' + @DatabaseName + '.ldf'', 
                        SIZE = ' + CAST(@LogSize AS NVARCHAR) + 'MB, 
                        FILEGROWTH = ' + CAST(@FileGrowthLog AS NVARCHAR) + 'MB )'

    -- Ejecutar la creaci칩n de la base de datos
    EXEC sp_executesql @SQL
```

**游늷 NOTA:** Ejecutar la variable no quiere decir que se termin칩 el procedimiento almacenado, si no que se ejecutar치 lo que se lleve al momento, esto es para poder agregar y crear un nuevo FileGroup, ya que para agregar a la BD esta ya debe de estar creada.

#### **Crear FileGroup (Opcional)**

* Por 칰ltimo, si es que el usuario agrego un nuevo FileGroup lo agregamos a la Base de Datos, para que este se vea reflejado debebos de agregarle un archivo, as칤 que, tambi칠n lo creamos y lo agregamos, en este caso lo estoy guardando en el mismo lugar que se guardo la Data. Y ejecutamos nuevamente nuestra variable de la consulta din치mica y terminamos el Procedimiento Almacenado.

```sql
    -- FILEGROUP ADICIONAL
    IF @FileGroupAdicional IS NOT NULL
    BEGIN
        -- Agregar FILEGROUP
        SET @SQL = 'ALTER DATABASE [' + @DatabaseName + '] ADD FILEGROUP [' + @FileGroupAdicional + ']'
        EXEC sp_executesql @SQL

        -- Agregar archivo al FILEGROUP
        SET @SQL = 'ALTER DATABASE [' + @DatabaseName + '] ADD FILE (
                        NAME = N''' + @DatabaseName + 'ArchivoAsociado'', 
                        FILENAME = N''' + @DataFilePath + '\' + @DatabaseName + '_SECUNDARIO.ndf''
                    ) TO FILEGROUP [' + @FileGroupAdicional + ']'
        EXEC sp_executesql @SQL
    END
END
```

**游늷 Nota:** Es importante primero crear la base de datos, antes de agregar el fileGroup, si no existir치 un error, que a mi me sucedi칩 y la soluci칩n es ejecutar la variable por separado, para que se cree la bd antes de crear el filegroup.

---

# CRAECI칍N DE LA APLICACI칍N
## Aplicaci칩n con ASP.net usando MVC
#### **Crear Proyecto**
* Crear un proyecto usando ASP.net Core (MVC) en Visual Studio de preferencia. 

![Crear Proyecto en VS.](../../images/CrearProyecto.png)

* Les asignamos un nombre y elegimos donde queremos que se guarde.

**游늷 NOTA:** El patr칩n de dise침o MVC, es Modelo, este es el que va relacionado a la BD, en este caso son las variables que nuestro procemiento almacenado esta esperando, Vista, esta es la interfaz Gr치fica que se le har치 llegar al usuario, donde se pedir치n los valores de las variables y por 칰ltimo el Controlador, aqu칤 aplicamos la l칩gica para cumplir con las operaciones necesarias, en este caso nos conectamos a sql, comenzamos el procedimiento, le mandamos los parametros y lo ejecutamos, en este caso estamos trabajando con Web, as칤 que el controlador tambi칠n nos ayuda a dirigir al usuario a la ruta que es, trabajamos con las cabeceras Post, Put, Get y Delete.

### **Creaci칩n de la Estructura de Carpetas**

* Creamos nuestra estructura de carpetas, esta es bastante importante m치s en la vista y controlador ya que son las que mandar치n al usuario a la ruta correspondiente.

![Crear Estructura de Carpetas.](../../images/EstructuraCarpetas.png)

*Nos quedar칤a algo como esta en la im치gen*

### **Definir el Modelo**

* Vamos al Modelo, que es lo principal.
Declaramos las variables necesarias que le pediremos al usuario y que nos pide el procedimiento almacenado que anteriormente ya creamos. Aqu칤 mismo le agregamos validaciones a cada campo que se pide, en caso de es

```c#
using System.ComponentModel.DataAnnotations;

namespace AdmonBD.Models
{
    public class CreateDatabaseModel
    {
        [Required(ErrorMessage = "El nombre de la base de datos es obligatorio.")]
        public string DatabaseName { get; set; }



        [Required(ErrorMessage = "La ruta del archivo de datos es obligatoria.")]
        public string DataFilePath { get; set; }



        [Required(ErrorMessage = "La ruta del archivo de log es obligatoria.")]
        public string LogFilePath { get; set; }



        [Range(10, int.MaxValue, ErrorMessage = "El tama침o de los archivos debe ser al menos 10 MB.")]
        public int DataSize { get; set; }



        [Range(5, int.MaxValue, ErrorMessage = "El crecimiento de los archivos de data debe ser al menos 5%.")]
        public int DataFileGrowth { get; set; }



        [Range(10, int.MaxValue, ErrorMessage = "El tama침o del archivo de log debe ser al menos 10 MB.")]
        public int LogSize { get; set; }



        [Range(5, int.MaxValue, ErrorMessage = "El crecimiento de los archivos de log debe ser al menos 5%.")]
        public int LogFileGrowth { get; set; }



        public string? FileGroupAdicional { get; set; }


        public bool Created { get; set; }
    }
}
```
---
### **Vista**
#### **Modelo de la Vista**
```csharp
@model CreateDatabaseModel
```
- Define que la vista utiliza el modelo `CreateDatabaseModel`, el cual contiene los datos necesarios para la creaci칩n de la base de datos.  
- **丘멆잺 Importante:** Este modelo debe estar correctamente definido en el proyecto con las propiedades necesarias.

#### **Configuraci칩n del t칤tulo de la p치gina**
```csharp
@{
    ViewData["Title"] = "Crear Base de Datos";
}
```
- Establece el t칤tulo de la p치gina para que pueda ser utilizado en la plantilla general (`_Layout.cshtml`).


#### **Contenedor del formulario**
```html
<div class="container mt-4">
    <h2 class="mb-4">Crear Base de Datos</h2>
```
- Define un contenedor con un t칤tulo para la interfaz del formulario.  

#### **Mensaje de 칠xito**
```csharp
@if (ViewBag.Message != null)
{
    <div class="alert alert-success mt-3">@ViewBag.Message</div>
}
```
- Si `ViewBag.Message` tiene contenido (por ejemplo, un mensaje de 칠xito tras crear la base de datos), lo muestra en un `div` con un mensaje de alerta.

#### **Inicio del formulario**
```html
<form asp-action="Create" method="post" class="needs-validation" novalidate>
``` 
- Define un formulario que env칤a los datos al m칠todo `Create` en el **`DatabaseController`** mediante `POST`.
- Usa `class="needs-validation"` y `novalidate`, que permite validaci칩n de Bootstrap sin activar la validaci칩n del navegador.


#### **Campos del formulario**
Cada campo usa `asp-for`, que vincula los inputs con las propiedades del modelo `CreateDatabaseModel`.  
Adem치s, cada campo tiene validaci칩n con `asp-validation-for`, lo que muestra errores si los datos no cumplen con las reglas del modelo.

#### **Campos clave**  
```html
<label class="form-label">Nombre de la Base de Datos</label>
<input asp-for="DatabaseName" class="form-control" required />
<span asp-validation-for="DatabaseName" class="text-danger"></span>
```
- Permite ingresar el nombre de la base de datos.  
- **丘멆잺 Importante:** `required` hace que el campo sea obligatorio en el frontend.  

---
```html
<label class="form-label">Ubicaci칩n del Archivo de Datos</label>
<input asp-for="DataFilePath" class="form-control" required />
```
- Permite ingresar la ubicaci칩n donde se guardar치 el archivo `.mdf`.  

---
```html
<label class="form-label">Tama침o de Datos (MB)</label>
<input asp-for="DataSize" type="number" class="form-control" required min="10" />
```
  - Solo permite ingresar valores num칠ricos.  
  - `min="10"` obliga a que el tama침o m칤nimo sea **10 MB**.  

---
```html
<label class="form-label">FileGroup Secundario (Opcional)</label>
<input asp-for="FileGroupAdicional" class="form-control" />
```

  - Permite ingresar un grupo de archivos secundario.  
  - No es obligatorio (`Opcional`).  

---

#### **Bot칩n de env칤o**
```html
<button type="submit" class="btn btn-primary">Crear</button>
```
- Env칤a el formulario para procesar la creaci칩n de la base de datos.   

 **Validaci칩n en backend y frontend:**  
   - El uso de `asp-validation-for` permite validar errores en el servidor.
   - El atributo `required` y `min` ayudan con la validaci칩n en el navegador.

 **Mensajes de 칠xito o error:**  
   - `ViewBag.Message` solo funciona si el formulario **no redirige** a otra vista.  
   - Si deseas mostrar un mensaje tras una redirecci칩n, usa `TempData["Message"]`.

---

### **Controlador**
#### **Dependencias**
* Agregamos las dependenacias necesarias para que funcione correctamente nuestro controlador.

```csharp
using AdmonBD.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Configuration;
using System.Threading.Tasks;
```

- **`using AdmonBD.Models;`**: Le decimos que haremos uso de nuestro modelo ya antes creado en la clase: `CreateDatabaseModel`.
- **`using Microsoft.AspNetCore.Mvc;`**: Importa las clases necesarias para trabajar con controladores y vistas en ASP.NET Core MVC.
- **`using Microsoft.Data.SqlClient;`**: Permite el uso de `SqlConnection`, `SqlCommand`, y otras clases necesarias para interactuar con la base de datos SQL Server.
- **`using Microsoft.Extensions.Configuration;`**: Permite acceder a la configuraci칩n de la aplicaci칩n, como las cadenas de conexi칩n.
- **`using System.Threading.Tasks;`**: Importa las clases necesarias para trabajar con tareas as칤ncronas, lo cual es importante para no bloquear el hilo de ejecuci칩n.

#### **Clase `DatabaseController`**

```csharp
namespace AdmonBD.Controllers
{
    public class DatabaseController : Controller
    {
        private readonly IConfiguration _configuration;
        private readonly string _connectionString;

        public DatabaseController(IConfiguration configuration)
        {
            _configuration = configuration;
            _connectionString = configuration.GetConnectionString("DefaultConnection");
        }
```

- **`public class DatabaseController : Controller`**: Define un controlador MVC llamado `DatabaseController` que hereda de la clase base `Controller`. Los controladores manejan las solicitudes HTTP, procesan la l칩gica de negocio y devuelven respuestas.
- **`private readonly IConfiguration _configuration;`**: Se declara una variable privada que almacenar치 la configuraci칩n de la aplicaci칩n. `IConfiguration` es una interfaz que permite acceder a los valores de configuraci칩n (como las cadenas de conexi칩n).
- **`private readonly string _connectionString;`**: Aqu칤 se guarda la cadena de conexi칩n a la base de datos. La cadena de conexi칩n es esencial para establecer la comunicaci칩n con la base de datos.
- **`public DatabaseController(IConfiguration configuration)`**: Constructor que inyecta la configuraci칩n de la aplicaci칩n a trav칠s de la interfaz `IConfiguration`. Esto permite acceder a las configuraciones definidas en los archivos de configuraci칩n como `appsettings.json`.
- **`_connectionString = configuration.GetConnectionString("DefaultConnection");`**: Obtiene la cadena de conexi칩n desde el archivo de configuraci칩n usando el nombre `"DefaultConnection"`.

#### **Acci칩n HTTP GET - Crear Base de Datos (Formulario)**

```csharp
[HttpGet]
public IActionResult Create()
{
    return View("~/Views/DataBase/Create.cshtml");
}
```

- **`[HttpGet]`**: Este atributo indica que la acci칩n manejar치 las solicitudes GET, es decir, cuando un usuario accede a la p치gina para crear una base de datos.
- **`public IActionResult Create()`**: Esta acci칩n devolver치 la vista para crear una base de datos, que probablemente es un formulario donde el usuario ingresar치 los detalles.
- **`return View("~/Views/DataBase/Create.cshtml");`**: Especifica la vista que se debe renderizar, en este caso, el archivo `Create.cshtml` dentro de la carpeta `Views/DataBase`. Por eso anteriormente se mencion칩 que la estructura de carpetas es importente en este tipo de proyectos web.

#### **Acci칩n HTTP POST - Procesar la Creaci칩n de la Base de Datos**

```csharp
[HttpPost]
public async Task<IActionResult> Create(CreateDatabaseModel model)
{
    try
    {
        // Validaci칩n de los par치metros necesarios
        if (string.IsNullOrEmpty(model.DatabaseName))
        {
            ViewBag.Message = "El nombre de la base de datos es obligatorio.";
            return View();
        }

        if (string.IsNullOrEmpty(model.DataFilePath))
        {
            ViewBag.Message = "La ruta del archivo de datos es obligatoria.";
            return View();
        }

        if (string.IsNullOrEmpty(model.LogFilePath))
        {
            ViewBag.Message = "La ruta del archivo de log es obligatoria.";
            return View();
        }
```

- **`[HttpPost]`**: Este atributo indica que la acci칩n maneja las solicitudes POST, que generalmente se env칤an cuando el usuario env칤a un formulario.
- **`public async Task<IActionResult> Create(CreateDatabaseModel model)`**: La acci칩n recibe un modelo (`CreateDatabaseModel`) que contiene los datos enviados desde el formulario. Es un m칠todo asincr칩nico, por lo que se usa `async` y `Task`.
- **`if (string.IsNullOrEmpty(model.DatabaseName))`**: Valida si el nombre de la base de datos est치 vac칤o. Si es as칤, muestra un mensaje de error.
- **`ViewBag.Message = "..."`**: `ViewBag` es un objeto que permite pasar datos desde el controlador a la vista. En este caso, se est치 pasando un mensaje que ser치 mostrado al usuario si ocurre alg칰n error.
- **`return View();`**: Si hay un error de validaci칩n, se retorna la vista nuevamente para que el usuario pueda corregir los datos.

#### **Conexi칩n y Ejecuci칩n de Procedimiento Almacenado**

```csharp
// Ejecutar el procedimiento almacenado en la base de datos
using (var connection = new SqlConnection(_connectionString))
{
    await connection.OpenAsync();

    using (var command = new SqlCommand("SP_CreateDatabase", connection))
    {
        command.CommandType = System.Data.CommandType.StoredProcedure;

        command.Parameters.AddWithValue("@DatabaseName", model.DatabaseName);
        command.Parameters.AddWithValue("@DataFilePath", model.DataFilePath);
        command.Parameters.AddWithValue("@LogFilePath", model.LogFilePath);
        command.Parameters.AddWithValue("@DataSize", model.DataSize);
        command.Parameters.AddWithValue("@LogSize", model.LogSize);
        command.Parameters.AddWithValue("@FileGrowthData", model.DataFileGrowth);
        command.Parameters.AddWithValue("@FileGrowthLog", model.LogFileGrowth);

        if (string.IsNullOrEmpty(model.FileGroupAdicional))
        {
            command.Parameters.AddWithValue("@FileGroupAdicional", DBNull.Value);
        }
        else
        {
            command.Parameters.AddWithValue("@FileGroupAdicional", model.FileGroupAdicional);
        }

        await command.ExecuteNonQueryAsync();
    }
}
```

- **`using (var connection = new SqlConnection(_connectionString))`**: Establece una conexi칩n a la base de datos usando la cadena de conexi칩n obtenida previamente.
- **`await connection.OpenAsync();`**: Abre la conexi칩n a la base de datos de manera asincr칩nica.
- **`using (var command = new SqlCommand("SP_CreateDatabase", connection))`**: Crea un objeto `SqlCommand` que ejecutar치 el procedimiento almacenado llamado `SP_CreateDatabase` en la base de datos.
- **`command.CommandType = System.Data.CommandType.StoredProcedure;`**: Especifica que el comando es un procedimiento almacenado, no una consulta SQL directa.
- **`command.Parameters.AddWithValue("...", model.Property);`**: Agrega par치metros al comando para que el procedimiento almacenado pueda utilizarlos. Cada uno de estos valores proviene del modelo recibido.
- **`await command.ExecuteNonQueryAsync();`**: Ejecuta el procedimiento almacenado de manera asincr칩nica. `ExecuteNonQueryAsync` se usa cuando no se espera un resultado, como es el caso al crear una base de datos.

#### **Manejo de Excepciones**

```csharp
catch (Exception ex)
{
    ViewBag.Message = $"Error al crear la base de datos: {ex.Message}";
    Console.WriteLine(ex);
}
```

- **`catch (Exception ex)`**: Si ocurre una excepci칩n durante la ejecuci칩n del c칩digo en el bloque `try`, el flujo de ejecuci칩n se mueve aqu칤.
- **`ViewBag.Message = $"Error al crear la base de datos: {ex.Message}";`**: Muestra un mensaje de error en la vista.
- **`Console.WriteLine(ex);`**: Imprime la excepci칩n en la consola, lo cual es 칰til para depurar, pero generalmente se debe evitar en producci칩n.

#### **Respuesta Final**

```csharp
ViewBag.Message = "Base de datos creada correctamente.";
return View();
```

- **`ViewBag.Message = "Base de datos creada correctamente.";`**: Si el procedimiento almacenado se ejecuta con 칠xito, se informa al usuario que la base de datos se cre칩 correctamente.
- **`return View();`**: Se retorna la vista nuevamente, mostrando el mensaje de 칠xito.

**游늷 Notas Importantes:**

1. **Inyecci칩n de dependencias**: La clase `DatabaseController` utiliza la inyecci칩n de dependencias para obtener la configuraci칩n de la aplicaci칩n (`IConfiguration`), lo que es una buena pr치ctica en ASP.NET Core para mantener el c칩digo limpio y modular.
2. **Procedimiento almacenado**: El c칩digo asume que ya existe un procedimiento almacenado llamado `SP_CreateDatabase` en la base de datos, lo que puede facilitar la gesti칩n de la base de datos directamente desde SQL.
3. **Manejo de errores**: El bloque `try-catch` ayuda a capturar excepciones que puedan surgir durante la ejecuci칩n de la operaci칩n de base de datos y devuelve un mensaje adecuado al usuario.
4. **Asincron칤a**: El uso de `async` y `await` mejora el rendimiento de la aplicaci칩n al permitir que otras solicitudes se manejen mientras se espera la ejecuci칩n de las operaciones de base de datos.
5. **Middleware**: ASP.NET Core utiliza middleware para procesar las solicitudes HTTP, lo cual permite agregar funcionalidades como autenticaci칩n, autorizaci칩n, manejo de excepciones y m치s, sin tener que modificar el c칩digo en el controlador.

**Y con esto tenemos nuestra aplicaci칩n web para la creacion de Bases de Datos en SQL Server.**

La Aplicaci칩n esta en la siguiente ruta:
'../../AppAdmonBD/AdmonBD'